# Library DB (PostgreSQL)

Консольное приложение на C++ для работы с библиотечной БД на PostgreSQL.
Библиотека: книги, авторы, читатели, экземпляры и выдачи.

## Требования (локально)

- g++ (C++17)
- libpqxx-dev, libpq-dev
- make

Пример установки на Linux:

```bash
sudo apt-get update
sudo apt-get install -y g++ libpqxx-dev libpq-dev make
```

## Сборка

Из папки `6Lab`:

```bash
make
```

Результат: бинарник `library_app`.

## Запуск (локально)

Перед запуском убедитесь, что PostgreSQL запущен.

Пример установки переменных окружения:

```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=library
export DB_USER=postgres
export DB_PASSWORD=postgres
```

Запуск:

```bash
./library_app
```

## Docker Compose (рекомендуется)

Запуск БД и приложения вместе:

```bash
docker compose up --build
```

Остановка:

```bash
docker compose down
```

База данных хранится в docker volume `pgdata`.

В compose добавлен healthcheck для PostgreSQL и ожидание в приложении, поэтому ошибка \"Connection refused\" при старте больше не должна появляться.

### Отдельный запуск (БД в фоне, приложение по требованию)

Запустить только БД:

```bash
docker compose up -d db
```

Запустить приложение отдельно (с интерактивным меню):

```bash
docker compose run --rm app
```

Такой режим удобен, если нужно периодически заходить в меню и не держать приложение постоянно запущенным.

### Если не работает `docker-compose`

На некоторых системах установлен устаревший `docker-compose` (v1 на Python), который падает с ошибкой `distutils`.
Рекомендуется использовать новый Compose v2:

```bash
docker compose up --build
```

Если у вас есть только `docker-compose`, попробуйте установить плагин:

```bash
sudo apt-get update
sudo apt-get install -y docker-compose-plugin
```

## Как подключиться к БД и работать с ней

Параметры подключения (из `docker-compose.yml`):
- host: `localhost`
- port: `5432`
- dbname: `library`
- user: `postgres`
- password: `postgres`

### Через psql (локально)

Если установлен клиент PostgreSQL:

```bash
psql -h localhost -p 5432 -U postgres -d library
```

### Через Docker (без установки psql)

```bash
docker exec -it vova_library-db-1 psql -U postgres -d library
```

### Пример запросов

```sql
\\dt
SELECT * FROM genres;
SELECT * FROM books;
SELECT * FROM readers;
```

### Работа с приложением

1) В меню выберите `1` (создать таблицы)
2) Выберите `2` (заполнить тестовыми данными)
3) Выберите `3` (запросы)

## Структура БД

Таблицы:
- `genres` — жанры
- `authors` — авторы
- `readers` — читатели
- `books` — книги
- `book_authors` — связи книга-автор
- `copies` — экземпляры книг
- `loans` — выдачи

## Главное меню

1. Инициализировать таблицы — создает таблицы в БД.
2. Заполнить тестовыми данными — вставляет демонстрационные записи.
3. Выполнить 10 основных запросов — меню запросов.
4. Демонстрация SQL-инъекций — показывает примеры уязвимых запросов.
5. Безопасный поиск книги — параметризованный поиск по названию.
6. Безопасное добавление книги — параметризованная вставка.
0. Выход.

## 10 основных запросов

1. Книги по жанру — вводите название жанра.
2. Книги с несколькими авторами — список книг, у которых >1 автора.
3. Авторы и количество книг — статистика по авторам.
4. Доступные экземпляры книги — список экземпляров со статусом `in_stock`.
5. Текущие выдачи — все выдачи без даты возврата.
6. Просроченные выдачи — выдачи с просрочкой и расчетом дней.
7. Популярные жанры — по количеству выдач.
8. Возврат книги — ввод `loan_id`, пересчет штрафа, возврат экземпляра.
9. Добавление читателя — ввод ФИО, группы, email, статуса.
10. Выдача книги — ввод `reader_id`, `copy_id`, `due_date`.

## Проверка работы (docker compose)

Рекомендуемый порядок:

1) Запустите `docker compose up --build`.
2) В меню приложения выберите `1` — инициализация таблиц.
3) Выберите `2` — заполнение тестовыми данными.
4) Выберите `3` — запуск запросов и проверьте несколько пунктов.

Пример проверки:

- `3` → `1` (жанр `Фантастика`) — получите список книг.
- `3` → `5` — увидите текущие выдачи.
- `3` → `6` — увидите просроченные выдачи.
- `3` → `8` — верните выдачу по `loan_id = 1` и проверьте штраф.

## Быстрый старт (docker)

```bash
docker compose up --build
```

Далее:
1) выбрать пункт 1
2) выбрать пункт 2
3) выбрать пункт 3 и проверять запросы
